#! /usr/bin/python3

"""
    Aim: on close milestone user selects finalize major milestone. The next
    (empty) minor milestone needs to be removed and the active milestone has to
    be set to the next major one (x.0).
"""

###  1. cretae calibrateMajorMsClosed() in mistctrl

@logger('(mistctrl.calibrateMajorMsClosed()')
def calibrateMajorMsClosed():

    """
        Invoked when a major milestone itme is closed. It calibrates the
        roadmap tree.
    """

    smajor, sminor = dc.sp.m.selected.v
    amajor, aminor = dc.sp.m.active.v

    if dc.sp.m.selected.v != dc.sp.m.active.v:

        raise Exception('selected, active missmatch on minor milestone'
                        'calibration')

    # remove next minor in active branch as we close the major branch
    nextminor = sminor + 1
    dc.sp.m._(major).index.v -= nextminor
    del dc.sp.m._(major).__dict__['_{}'.format(nextminor)]

    # set the milestone status
    dc.sp.m.active.v = (amajor + 1, 0)
    dc.sp.m.selected.v = (amajor + 1, 0)

###  2. create onMajorMilestoneFinalized()

@logger('NxRoadmap.onMajorMilestoneFinalized(self)', 'self')
def onMajorMilestoneFinalized(self):

    # we start with finisching milestone item closing that was started
    # before the dialog appeared. This is the same as the last part of
    # onMiClosed. We just leave out the table reload, as the following
    # milestone selection switch will take care of that.
    smiid = dc.x.roadmap.smiid.v
    dc.sp.m.mi._(smiid).status.v = 'Closed'
    self.touchRoadmap()
    logMiEvent('closed', 'item has been closed')

    # calibrate roadmap tree
    mistctrl.calibrateMajorMsClosed()

    # hide finalize dialog
    dc.ui.finalize.v.hide()
    dc.ui.roadmap.v.gridLayout_4.removeWidget(dc.ui.finalize.v)
    dc.ui.roadmap.v.gridLayout_4.addWidget(dc.ui.roadmap.v.body, 1, 0)
    dc.ui.roadmap.v.body.show()

    dc.ui.roadmap.v.btn_milestone_button.updateMenuTree()

    applyStates(states._open, dc.ui.roadmap.v)

    # reload tabel
    milist.reloadTable()

###  3. connect gui signal with method

dc.ui.finalize.v.btn_finmajor.clicked.connect(dc.m.roadmap.v.onMajorMilestoneFinalized)


